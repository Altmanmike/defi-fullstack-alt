#version: '3.8'

services:
  # --- 1. SERVICE BACKEND (API PHP 8.4) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    # Le port 9000 est le port par défaut de PHP-FPM
    expose:
      - '9000'
    volumes:
      # Montage du code pour le développement (changement immédiat)
      - ./backend:/var/www/html
    # Ajouter les variables d'environnement de la DB ici
    environment:
      DATABASE_URL: 'pgsql://user:password@database:5432/db_name'
      # Autres secrets...
    restart: unless-stopped

  # --- 2. SERVICE FRONTEND  ---
  frontend:
    # Utilise le Dockerfile.dev que nous venons de créer
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev 
    # Mappe le port Vite (5173) au port local
    ports:
      - "5173:5173" 
    environment:
      # Laissez l'hôte Vite à 0.0.0.0 pour l'accessibilité Docker
      - VITE_HOST=0.0.0.0 
    volumes:
      # Montage du code source (pour le développement en temps réel)
      - ./frontend:/app 
      # Empêche Node.js de réécrire les modules sur le volume Windows (très important)
      - /app/node_modules
    depends_on:
      - backend # Assure que le backend démarre avant

  # --- 3. SERVICE BASE DE DONNÉES (POSTGRESQL) ---
  database:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: db_name
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      # ATTENTION: ces credentials doivent être gérés comme des secrets
      # dans un environnement de production réel.
    volumes:
      # Persistance des données de la DB
      - db_data:/var/lib/postgresql/data
    restart: unless-stopped
    # Le port n'a pas besoin d'être exposé au monde extérieur, 
    # seul le backend y accède.

  # --- 4. SERVEUR WEB (NGINX) --- 
  nginx:
    image: nginx:stable-alpine
    container_name: defi-fullstack-alt-nginx-1
    ports:
        # Expose le port 8088 de l'hôte au port 80 du conteneur Nginx
        - "8088:80" 
    volumes:
        # Monte le répertoire public de Symfony dans Nginx
        - ./backend/public:/var/www/html/public:ro
        # Monte votre configuration Nginx personnalisée
        - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
        - backend

# --- VOLUMES pour la persistance des données ---
volumes:
  db_data: